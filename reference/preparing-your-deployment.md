---
description: >-
  In this section, you will find more details on how to configure Charles’
  deploy module and how to prepare your application to be available in the
  cluster.
---

# Preparing your deployment

The deployment module monitors and applies the cluster resources. To do that, it uses the [**Operator**](https://kubernetes.io/docs/concepts/extend-kubernetes/operator) pattern that performs reconciliation cycles to make sure that the cluster will always be in the state you need. Kubernetes' logs will also be collected in real-time.

## **Deployment configuration**

Charles has an architecture that adapts different Kubernetes installations. This deployment configuration indicates which URL and Git credentials will be used to search for helm charts. Your module needs to be installed in the destination cluster with an accessible URL, without this configuration Charles will not deploy. 

### **How can you register the configuration?**

Follow the steps below: 

1. In **Workspaces,** at the left menu, select your workspace and then click on **Settings ;**
2. Click on **Credentials;**
3. Click on **Add Deployment Configuration;**

Fill in these fields:

1. **Butler URL:**  Butler's deploy module URL. If this is in the same Charles' installation cluster, use your FQDN \(Fully Qualified Domain Name\). Example: **http://charlescd-butler.butler-namespace.svc.cluster.local:3000.**
2. **Namespace:** Define the namespace where the resources will be available in the cluster. You have to create your namespace, once Charles does not do it;
3. **Git provider:** defines the git provider you will use ****\(**GitHub or GitLab**\);
4. **Git token:** Insert an authentication token that has access to the git repository where your [**helm templates**](../get-started/creating-your-first-module/) ****are stored \(they will be used during the deployment of your application\). If your Git Provider is **GitHub**, "_repo_" permission is required**.** Otherwise, configure the accesses in **GitLab:** "_API_" and "_read\_repository_".

## **Configuring your application**

The deployment module Butler uses helm charts to make your application available in the cluster. The charts must be available in a Github or Gitlab repository and you can access them through a token, previously registered in the deployment configuration. The URL is provided along with the module registration. 

### **Charts**

The charts must follow the [**Helm pattern**](https://helm.sh/docs/topics/charts/) ****and they need to be contained in a folder with the registered component on Charles. You don't need to run any command to bundle the chart, Charles downloads and it finishes automatically.   
  
See the below an example of a repository containing the component's chart  **http-https-echo** on GitHub:

![](https://lh5.googleusercontent.com/Rt7_Lw1DbK152QKt3brsCYyzF0DAQ4wuoWsdCVyUaZjf9Hlh64EaK7YnHjF16W_xo2BQzlUJyUeUsooPzqwmMIKF7ttUXRej3eM56uWu6WH4QNCiByixeV4zEdHLwEGRq7NCruhH)

### **Templates**

The templates don't need any special treatment. The only requirement is to generate valid manifests.   
  
Butler internally stores the compiled charts in entities that represent each deployment request. Thereby, you can perform more efficient rollbacks. 

### **Properties injections**

The property injection in the manifest performed by Butler is important and you have to remember using it when preparing your application. See what they are:  

* **name:**  Kubernetes’ resource name. **** Some resources managed by Charles need to have their names altered, in order to make different versions of the same application available in different circles. The property name will have the following value:  ****  **&lt;originalManifest.metadata.name&gt;-&lt;tag&gt;-&lt;deploymentId&gt;** 
* **originalManifest.metadata.name:** Name generated by the application’s chart;
* **tag:** Image’s tag;
* **deploymentId:** Deployment’s entity unique identifier created by Butler.

{% hint style="warning" %}
This update only happens in **Deployment’s** type resources.
{% endhint %}

* **namespace:** Your deployment's namespace. ****This namespace is described during the Workspace configuration and indicates which namespace the deployment will happen. If the charts insert this value in the manifests, Charles will overwrite them. ****
* **labels:** Kubernetes’ resources labels. ****In order to make Butler’s reconciliation cycle and Istio’s routes created correctly work, some labels need to be available in all resources applied to the cluster. See them below: 
  * **deploymentId:** Unique identifier of the deployment's entity created by Butler; 
  * **circleId:** Unique circle's identifier where the deployment will be created. 

After this configuration, you can use Charles to perform deployment in your application in segmented circles.   
  
****  


